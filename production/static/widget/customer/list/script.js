"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function r(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(t,e,a){return e&&r(t.prototype,e),a&&r(t,a),t}}();function _defineProperty(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}common.pluginsTools.loadPlugins(function(){return new CustomerList},["template","eventproxy","highcharts"]);var UNIT={bid:"",click:"",conversion:"",cost:Currency,impression:"",income:Currency,revenue:Currency,win:""},CustomerList=function(){function a(){var e=this;_classCallCheck(this,a),helper(),this.$customer=$("#customer-list"),common.permission.has("queryOperationAccountList")?Query.AMs.then(function(t){$("#am-selector").append(t.map(function(t){return'<option value="'+t.accountId+'">'+t.contactName+"</option>"}).join(""))}):$("#am-selector").html('<option value="">'+common.get("name")+"</option>").prop("disabled","disabled");paramFactory({limit:50});var t=renderPage($(".page"),function(t){return e.genCustomerList(t)});this.genCustomerList=this.customerListFactory(t),this.genCampaignList=this.campaignListFactory(),this.genCampaignReport=this.campaignReportFactory(),this.genUserHourlyReport=this.userHourlyReportFactory(),this.events(),this.init(),Highcharts.setOptions({lang:{shortMonths:["一","二","三","四","五","六","七","八","九","十","十一","十二"]}})}return _createClass(a,[{key:"init",value:function(){this.genCustomerList(),this.queryCustomer()}},{key:"events",value:function(){var t=$("#show-all"),a=$("#am-selector"),r=$(".filter").focus(),o=this;r.on("keyup",function(t){var e;"13"==(t.charCode||t.keyCode)&&(e=$(this).attr("data-key"),o.genCustomerList(_defineProperty({},e,$(this).val())),r.each(function(){e!=$(this).attr("data-key")&&$(this).val("")}))}),t.on("click",function(){r.val(""),a.val(""),o.genCustomerList()}),a.on("change",function(){var t=a.val();""===t&&o.genCustomerList.removeParam(["amId"]);var e=t?{amId:t}:{};o.genCustomerList(e)}),this.$customer.on("click","[customer-order]",function(){var t=$(this).attr("customer-order");o.genCustomerList({orderParam:t})}).on("click","[os-param-id]",function(t){var e=$(this).attr("os-param-id"),a=prime_host+"/?osParamId="+e;window.open(a,"aaa")}).on("click","[campaign-list]",function(){var t=$(this).attr("campaign-list");o.showDetail(t)}).on("click","[all-campaign]",function(){var t=$(this).attr("all-campaign");window.open("/index.html?goto=audit&mold=list&userId="+t)}).on("click","[user-history]",function(){var t=$(this).attr("user-history"),e=$(this).attr("account-email");o.genUserHourlyReport({accountId:t},{email:e})}).on("click","[campaign-order]",function(){var t=$(this).attr("campaign-order");o.genCampaignList({orderParam:t})}).on("click","[campaign-id]",function(){var t=$(this).attr("campaign-id"),e=moment().add(-1,"days").format("YYYY-MM-DD");o.genCampaignReport({campaignId:t,startDate:e,endDate:e},{days:-1})}).on("click","[reason]",function(t){var e=$(this).attr("reason"),a=$.param({qtime:"",qcamp:e,latest15:"查询最近15分钟"});window.open(window.filter_reason_host+"/filter_reason/?"+a),t.stopPropagation()}),$("#myModal").on("click","[top5]",function(){var t=0|$(this).attr("top5"),e=moment().add(t,"days").format("YYYY-MM-DD");o.genCampaignReport({startDate:e,endDate:e},{days:t})}).on("hidden.bs.modal",function(t){$(this).find(".modal-body").empty()}),Highcharts.Pointer.prototype.reset=function(){},Highcharts.Point.prototype.highlight=function(t){this.onMouseOver(),this.series.chart.tooltip.refresh(this),this.series.chart.xAxis[0].drawCrosshair(t,this)}}},{key:"showDetail",value:function(t){var e=$("#customer-detail-"+t);if(e.data("display"))return e.data("display",!1).empty(),e.hide();e.show().data("display",!0),this.genCampaignList({accountId:t},e)}},{key:"queryCampaignReportByUser",value:function(t){var e=t.accountId;return common.ajaxGet("queryCampaignReportByUser",{accountId:e})}},{key:"queryCustomer",value:function(){var e=$("#filter-result");return common.ajaxGet("queryCustomer").done(function(t){0==t.status&&e.html(template("filterResult",{customers:t.data.list}))})}},{key:"customerListFactory",value:function(a){function t(t){var e=o.update(t);return common.ajaxGet("queryCustomerAccountList",e).done(function(t){0==t.status&&(r.$customer.html(template("customerList",{customers:t.data.list,param:o.param})),a(t.data.paging),popover(r.$customer.find(".customerName")),9==common.get("roleId")&&$(".customer-operation").empty(),setTimeout(function(){$("#customer-list table.table-striped-manu").tableExport({formats:["xlsx"]})}))})}var r=this,o=paramFactory({limit:50});return t.removeParam=o.remove,t}},{key:"campaignListFactory",value:function(){var o,n=paramFactory();return function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:o,a=n.update(t),r=e.loading();return common.ajaxGet("queryCampaignReportByUser",a).done(function(t){r(),0==t.status&&(o=e).html(template("campaignList",{data:t.data.list,param:n.param}))})}}},{key:"campaignReportFactory",value:function(){var r=this,o=paramFactory(),n=$("#myModal .modal-body");return function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=o.update(t);return r.showModal(),common.ajaxGet("queryCampaignReportByDimension",a).done(function(t){0==t.status&&n.html(template("campaignReport",{data:t.data.list,param:o.param,tmpData:e}))})}}},{key:"showModal",value:function(){return $("#myModal").modal()}},{key:"userHourlyReportFactory",value:function(){var r=this,o=paramFactory({groupBy:2,limit:72,startDate:moment().endOf("day").add(-2,"days").format("YYYY-MM-DD"),endDate:moment().endOf("day").format("YYYY-MM-DD")}),n=$("#myModal .modal-body");return function(t){var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},e=o.update(t);return r.showModal(),r.data={},common.ajaxGet("queryUserHourlyReport",e).done(function(e){0==e.status&&(n.html(template("userHourlyReport",{data:e.data.list,param:o.param,tmpData:a})),r.bindHourChartEvents(),setTimeout(function(){var t=e.data.list.reduce(function(t,e){var a=Object.assign({},e);return delete a.date,delete a.hour,t[e.date+e.hour]=a,t},{});r.data=t,r.addCharts(t)},100))})}}},{key:"addCharts",value:function(a,t){var r=this,o=1<arguments.length&&void 0!==t?t:2;$("#main1, #main2").empty(),Object.keys(this.defaultHourDate()).map(function(t,e){$('<div class="chart">').appendTo("#main"+(e%2+1)).highcharts(r.makeChartOption(t,a,o))})}},{key:"bindHourChartEvents",value:function(){function e(){for(Highcharts.charts.forEach(function(t){return t.destroy()});Highcharts.charts.length;)Highcharts.charts.shift()}var a=this;$("#myModal").one("hide.bs.modal",e),$("#hourly-report-top").on("click","button[duration]",function(){$("#hourly-report-top button[duration]").prop("class","btn btn-default"),$(this).prop("class","btn btn-primary");var t=$(this).attr("duration");e(),a.addCharts(a.data,t)});function t(i){return function(t){for(var e,a,r=Highcharts.charts[i],o=r.pointer.normalize(t.originalEvent),n=0;n<Highcharts.charts.length;n+=1)(e=(r=Highcharts.charts[n]).series[0].searchPoint(o,!0))&&e.highlight(t);r.hoverPoint&&(a=r.series[0].data[r.hoverPoint.index].category,$("#hourly-report-top .date").html(moment(a).format("YYYY-MM-DD HH:00")))}}$("#main1").bind("mousemove touchmove touchstart",t(0)),$("#main2").bind("mousemove touchmove touchstart",t(1))}},{key:"makeChartOption",value:function(r,o,t){var n=[];this.makeHour(t).map(function(t){var e=t.date,a=t.hour;o[e+a]?n.push(o[e+a][r]):n.push(0)});var e=UNIT[r],a={name:r,value:n,unit:e};return{chart:{marginLeft:80,marginRight:20,spacingTop:30,spacingBottom:20,height:140,backgroundColor:"#fafafa"},title:{text:a.name,align:"left",margin:0,x:30,y:-1},credits:{enabled:!1},legend:{enabled:!1},xAxis:{crosshair:{color:Highcharts.Color("#d28900").setOpacity(.1).get()},events:{setExtremes:syncExtremes},type:"datetime",plotBands:[{color:Highcharts.Color(Highcharts.defaultOptions.colors[0]).setOpacity(.2).get(),from:moment().endOf("day").add(-2,"days").add(1,"hours").valueOf(),to:moment().endOf("day").add(-1,"days").add(1,"hours").valueOf()}]},yAxis:{title:{text:null},min:0},plotOptions:{series:{color:Highcharts.Color(Highcharts.defaultOptions.colors[0]).get(),marker:{enabled:!1}}},tooltip:{positioner:function(){return{x:this.chart.chartWidth-this.label.width,y:-1}},borderWidth:0,backgroundColor:"none",formatter:function(){return formatNumber(this.y,this.series.name)},shadow:!1,style:{fontSize:"18px"}},series:[{name:a.name,data:a.value,pointStart:moment().endOf("day").add(-1*t,"days").add(1,"hours").valueOf(),pointInterval:36e5,type:"line",fillOpacity:.3}]}}},{key:"defaultHourDate",value:function(t,e){var a=0<arguments.length&&void 0!==t?t:{},r=1<arguments.length&&void 0!==e?e:{};return Object.assign({},{bid:0,income:0,win:0,impression:0,click:0,conversion:0},a,r)}},{key:"makeHour",value:function(t){for(var e=0<arguments.length&&void 0!==t?t:0,a=moment().add(-(e-1)-1,"days"),r=[],o=0;o<e;o++)for(var n=0,i=(a=a.add(1,"days")).format("YYYY-MM-DD");n<24;)r.push({date:i,hour:String.prototype.substr.call("0"+n,-2)+":00"}),n+=1;return r}}]),a}();function paramFactory(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(this===window)return new paramFactory(newParam);var e=$.extend({},t),a=$.extend({},e);return{update:function(t){return t?(t.orderParam&&(t.currentPage=1,t.orderFlag=t.orderParam===a.orderParam&&"1"==a.orderFlag?"2":"1"),$.extend(a,t)):a=$.extend({},e),$.extend({},a)},remove:function(t){var e=0<arguments.length&&void 0!==t?t:[];_.each(e,function(t){delete a[t]})},get param(){return $.extend({},a)}}}function popover(t){t.each(function(){var t=this;$(this).popover({placement:"bottom",trigger:"click"});$(this).parent().on("click",function(t){t.stopPropagation()}),$(this).on("shown.bs.popover",function(){$("body").on("click.clickpopover",function(){$(t).popover("hide"),$("body").off("click.clickpopover")})})})}function renderPage(e,a){e.on("click","a",function(){var t;$(this).hasClass("disabled")||(t=$(this).attr("page"))&&a({currentPage:t})});return function(t){return e.html(template("pageTemp",{pager:t}))}}function helper(){template.helper("sort",function(t,e){if(e.orderParam==t)switch(e.orderFlag){case"2":return'<i class="glyphicon glyphicon-sort-by-attributes" />';case"1":return'<i class="glyphicon glyphicon-sort-by-attributes-alt" />'}return'<i class="glyphicon glyphicon-sort op30" />'}),template.helper("numeral",function(){return numeral.apply(void 0,arguments)}),template.helper("fn",function(){for(var t=arguments.length,e=Array(t),a=0;a<t;a++)e[a]=arguments[a];return formatNumber.apply(void 0,[0].concat(e))}),template.helper("fns",function(){for(var t=arguments.length,e=Array(t),a=0;a<t;a++)e[a]=arguments[a];return formatNumber.apply(void 0,[0].concat(e))})}function formatNumber(t,e,a){"object"==(void 0===e?"undefined":_typeof(e))&&(e=e[a]);var r=t?" a":"";switch(a){case"bid":case"win":case"impression":case"click":case"conversion":return numeral(e).format("0,0"+r);case"ctr":case"cvr":return numeral(e).format("0,0.0%");case"cpm":return Currency+" "+numeral(e).format("0.00"+r);case"impwin":case"winRate":return numeral(e).format("0.0%");case"win_avg":case"income":case"cost":case"revenue":case"balance":case"totalSpend":case"lastMonthSpend":case"currentMonthSpend":case"beforeYesterdaySpend":case"yesterdaySpend":case"todaySpending":case"todaySpend":return Currency+" "+numeral(e).format("0.00"+r)}}function syncExtremes(e){var a=this.chart;"syncExtremes"!==e.trigger&&Highcharts.each(Highcharts.charts,function(t){t!==a&&t.xAxis[0].setExtremes&&t.xAxis[0].setExtremes(e.min,e.max,void 0,!1,{trigger:"syncExtremes"})})}