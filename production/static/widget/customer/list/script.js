"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,a,r){return a&&t(e.prototype,a),r&&t(e,r),e}}();function _defineProperty(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}common.pluginsTools.loadPlugins(function(){return new CustomerList},["template","eventproxy","highcharts"]);var UNIT={bid:"",click:"",conversion:"",cost:Currency,impression:"",income:Currency,revenue:Currency,win:""},CustomerList=function(){function t(){var e=this;_classCallCheck(this,t),helper(),this.$customer=$("#customer-list"),common.permission.has("queryOperationAccountList")?Query.AMs.then(function(t){$("#am-selector").append(t.map(function(t){return'<option value="'+t.accountId+'">'+t.contactName+"</option>"}).join(""))}):$("#am-selector").html('<option value="">'+common.get("name")+"</option>").prop("disabled","disabled");paramFactory({limit:50});var a=renderPage($(".page"),function(t){return e.genCustomerList(t)});this.genCustomerList=this.customerListFactory(a),this.genCampaignList=this.campaignListFactory(),this.genCampaignReport=this.campaignReportFactory(),this.genUserHourlyReport=this.userHourlyReportFactory(),this.events(),this.init(),Highcharts.setOptions({lang:{shortMonths:["一","二","三","四","五","六","七","八","九","十","十一","十二"]}})}return _createClass(t,[{key:"init",value:function(){this.genCustomerList(),this.queryCustomer()}},{key:"events",value:function(){var t=$("#show-all"),e=$("#am-selector"),a=$(".filter").focus(),r=this;a.on("keyup",function(t){if("13"==(t.charCode||t.keyCode)){var e=$(this).attr("data-key");r.genCustomerList(_defineProperty({},e,$(this).val())),a.each(function(){e!=$(this).attr("data-key")&&$(this).val("")})}}),t.on("click",function(){a.val(""),e.val(""),r.genCustomerList()}),e.on("change",function(){var t=e.val();""===t&&r.genCustomerList.removeParam(["amId"]);var a=t?{amId:t}:{};r.genCustomerList(a)}),this.$customer.on("click","[customer-order]",function(){var t=$(this).attr("customer-order");r.genCustomerList({orderParam:t})}).on("click","[os-param-id]",function(t){var e=$(this).attr("os-param-id"),a=prime_host+"/?osParamId="+e;window.open(a,"aaa")}).on("click","[campaign-list]",function(){var t=$(this).attr("campaign-list");r.showDetail(t)}).on("click","[all-campaign]",function(){var t=$(this).attr("all-campaign");window.open("/index.html?goto=audit&mold=list&userId="+t)}).on("click","[user-history]",function(){var t=$(this).attr("user-history"),e=$(this).attr("account-email");r.genUserHourlyReport({accountId:t},{email:e})}).on("click","[campaign-order]",function(){var t=$(this).attr("campaign-order");r.genCampaignList({orderParam:t})}).on("click","[campaign-id]",function(){var t=$(this).attr("campaign-id"),e=moment().add(-1,"days").format("YYYY-MM-DD"),a=e;r.genCampaignReport({campaignId:t,startDate:e,endDate:a},{days:-1})}).on("click","[reason]",function(t){var e=$(this).attr("reason"),a=$.param({qtime:"",qcamp:e,latest15:"查询最近15分钟"});window.open(window.filter_reason_host+"/filter_reason/?"+a),t.stopPropagation()}),$("#myModal").on("click","[top5]",function(){var t=0|$(this).attr("top5"),e=moment().add(t,"days").format("YYYY-MM-DD"),a=e;r.genCampaignReport({startDate:e,endDate:a},{days:t})}).on("hidden.bs.modal",function(t){$(this).find(".modal-body").empty()}),Highcharts.Pointer.prototype.reset=function(){},Highcharts.Point.prototype.highlight=function(t){this.onMouseOver(),this.series.chart.tooltip.refresh(this),this.series.chart.xAxis[0].drawCrosshair(t,this)}}},{key:"showDetail",value:function(t){var e=$("#customer-detail-"+t);if(e.data("display"))return e.data("display",!1).empty(),e.hide();e.show().data("display",!0),this.genCampaignList({accountId:t},e)}},{key:"queryCampaignReportByUser",value:function(t){var e=t.accountId;return common.ajaxGet("queryCampaignReportByUser",{accountId:e})}},{key:"queryCustomer",value:function(){var t=$("#filter-result");return common.ajaxGet("queryCustomer").done(function(e){0==e.status&&t.html(template("filterResult",{customers:e.data.list}))})}},{key:"customerListFactory",value:function(t){var e=this,a=paramFactory({limit:50}),r=function(r){var o=a.update(r);return common.ajaxGet("queryCustomerAccountList",o).done(function(r){0==r.status&&(e.$customer.html(template("customerList",{customers:r.data.list,param:a.param})),t(r.data.paging),popover(e.$customer.find(".customerName")),9==common.get("roleId")&&$(".customer-operation").empty(),setTimeout(function(){$("#customer-list table.table-striped-manu").tableExport({formats:["xlsx"]})}))})};return r.removeParam=a.remove,r}},{key:"campaignListFactory",value:function(){var t,e=paramFactory();return function(a){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t,o=e.update(a),n=r.loading();return common.ajaxGet("queryCampaignReportByUser",o).done(function(a){n(),0==a.status&&(t=r,r.html(template("campaignList",{data:a.data.list,param:e.param})))})}}},{key:"campaignReportFactory",value:function(){var t=this,e=paramFactory(),a=$("#myModal .modal-body");return function(r){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e.update(r);return t.showModal(),common.ajaxGet("queryCampaignReportByDimension",n).done(function(t){0==t.status&&a.html(template("campaignReport",{data:t.data.list,param:e.param,tmpData:o}))})}}},{key:"showModal",value:function(){return $("#myModal").modal()}},{key:"userHourlyReportFactory",value:function(){var t=this,e=paramFactory({groupBy:2,limit:72,startDate:moment().endOf("day").add(-2,"days").format("YYYY-MM-DD"),endDate:moment().endOf("day").format("YYYY-MM-DD")}),a=$("#myModal .modal-body");return function(r){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e.update(r);return t.showModal(),t.data={},common.ajaxGet("queryUserHourlyReport",n).done(function(r){0==r.status&&(a.html(template("userHourlyReport",{data:r.data.list,param:e.param,tmpData:o})),t.bindHourChartEvents(),setTimeout(function(){var e=r.data.list.reduce(function(t,e){var a=Object.assign({},e);return delete a.date,delete a.hour,t[e.date+e.hour]=a,t},{});t.data=e,t.addCharts(e)},100))})}}},{key:"addCharts",value:function(t){var e=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;$("#main1, #main2").empty(),Object.keys(this.defaultHourDate()).map(function(r,o){$('<div class="chart">').appendTo("#main"+(o%2+1)).highcharts(e.makeChartOption(r,t,a))})}},{key:"bindHourChartEvents",value:function(){var t=function(){for(Highcharts.charts.forEach(function(t){return t.destroy()});Highcharts.charts.length;)Highcharts.charts.shift()},e=this;$("#myModal").one("hide.bs.modal",t),$("#hourly-report-top").on("click","button[duration]",function(){$("#hourly-report-top button[duration]").prop("class","btn btn-default"),$(this).prop("class","btn btn-primary");var a=$(this).attr("duration");t(),e.addCharts(e.data,a)});var a=function(t){return function(e){var a,r,o=Highcharts.charts[t],n=o.pointer.normalize(e.originalEvent);for(r=0;r<Highcharts.charts.length;r+=1)(a=(o=Highcharts.charts[r]).series[0].searchPoint(n,!0))&&a.highlight(e);if(o.hoverPoint){var i=o.series[0].data[o.hoverPoint.index].category;$("#hourly-report-top .date").html(moment(i).format("YYYY-MM-DD HH:00"))}}};$("#main1").bind("mousemove touchmove touchstart",a(0)),$("#main2").bind("mousemove touchmove touchstart",a(1))}},{key:"makeChartOption",value:function(t,e,a){var r=[];this.makeHour(a).map(function(a){var o=a.date,n=a.hour;e[o+n]?r.push(e[o+n][t]):r.push(0)});var o=UNIT[t],n={name:t,value:r,unit:o};return{chart:{marginLeft:80,marginRight:20,spacingTop:30,spacingBottom:20,height:140,backgroundColor:"#fafafa"},title:{text:n.name,align:"left",margin:0,x:30,y:-1},credits:{enabled:!1},legend:{enabled:!1},xAxis:{crosshair:{color:Highcharts.Color("#d28900").setOpacity(.1).get()},events:{setExtremes:syncExtremes},type:"datetime",plotBands:[{color:Highcharts.Color(Highcharts.defaultOptions.colors[0]).setOpacity(.2).get(),from:moment().endOf("day").add(-2,"days").add(1,"hours").valueOf(),to:moment().endOf("day").add(-1,"days").add(1,"hours").valueOf()}]},yAxis:{title:{text:null},min:0},plotOptions:{series:{color:Highcharts.Color(Highcharts.defaultOptions.colors[0]).get(),marker:{enabled:!1}}},tooltip:{positioner:function(){return{x:this.chart.chartWidth-this.label.width,y:-1}},borderWidth:0,backgroundColor:"none",formatter:function(){return formatNumber(this.y,this.series.name)},shadow:!1,style:{fontSize:"18px"}},series:[{name:n.name,data:n.value,pointStart:moment().endOf("day").add(-1*a,"days").add(1,"hours").valueOf(),pointInterval:36e5,type:"line",fillOpacity:.3}]}}},{key:"defaultHourDate",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object.assign({},{bid:0,income:0,win:0,impression:0,click:0,conversion:0},t,e)}},{key:"makeHour",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=moment().add(-(t-1)-1,"days"),a=[],r=0;r<t;r++)for(var o=0,n=(e=e.add(1,"days")).format("YYYY-MM-DD");o<24;)a.push({date:n,hour:String.prototype.substr.call("0"+o,-2)+":00"}),o+=1;return a}}]),t}();function paramFactory(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this===window)return new paramFactory(newParam);var e=$.extend({},t),a=$.extend({},e);return{update:function(t){return t?(t.orderParam&&(t.currentPage=1,t.orderFlag=t.orderParam===a.orderParam&&"1"==a.orderFlag?"2":"1"),$.extend(a,t)):a=$.extend({},e),$.extend({},a)},remove:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];_.each(t,function(t){delete a[t]})},get param(){return $.extend({},a)}}}function popover(t){t.each(function(){var t=this;$(this).popover({placement:"bottom",trigger:"click"});$(this).parent().on("click",function(t){t.stopPropagation()}),$(this).on("shown.bs.popover",function(){$("body").on("click.clickpopover",function(){$(t).popover("hide"),$("body").off("click.clickpopover")})})})}function renderPage(t,e){t.on("click","a",function(){if(!$(this).hasClass("disabled")){var t=$(this).attr("page");t&&e({currentPage:t})}});return function(e){return t.html(template("pageTemp",{pager:e}))}}function helper(){template.helper("sort",function(t,e){if(e.orderParam==t)switch(e.orderFlag){case"2":return'<i class="glyphicon glyphicon-sort-by-attributes" />';case"1":return'<i class="glyphicon glyphicon-sort-by-attributes-alt" />'}return'<i class="glyphicon glyphicon-sort op30" />'}),template.helper("numeral",function(){return numeral.apply(void 0,arguments)}),template.helper("fn",function(){for(var t=arguments.length,e=Array(t),a=0;a<t;a++)e[a]=arguments[a];return formatNumber.apply(void 0,[0].concat(e))}),template.helper("fns",function(){for(var t=arguments.length,e=Array(t),a=0;a<t;a++)e[a]=arguments[a];return formatNumber.apply(void 0,[0].concat(e))})}function formatNumber(t,e,a){"object"==(void 0===e?"undefined":_typeof(e))&&(e=e[a]);var r=t?" a":"";switch(a){case"bid":case"win":case"impression":case"click":case"conversion":return numeral(e).format("0,0"+r);case"ctr":case"cvr":return numeral(e).format("0,0.0%");case"cpm":return Currency+" "+numeral(e).format("0.00"+r);case"impwin":case"winRate":return numeral(e).format("0.0%");case"win_avg":case"income":case"cost":case"revenue":case"balance":case"totalSpend":case"lastMonthSpend":case"currentMonthSpend":case"beforeYesterdaySpend":case"yesterdaySpend":case"todaySpending":case"todaySpend":return Currency+" "+numeral(e).format("0.00"+r)}}function syncExtremes(t){var e=this.chart;"syncExtremes"!==t.trigger&&Highcharts.each(Highcharts.charts,function(a){a!==e&&a.xAxis[0].setExtremes&&a.xAxis[0].setExtremes(t.min,t.max,void 0,!1,{trigger:"syncExtremes"})})}